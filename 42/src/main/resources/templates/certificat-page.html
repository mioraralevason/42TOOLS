<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>

    <!-- CSS global -->
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <!-- CSS Sidebar -->
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>

    <div class="container">
        <!-- Hover area to trigger sidebar -->
        <div class="hover-area"></div>

        <!-- Sidebar -->
        <div th:replace="fragments/sidebar :: sidebar"></div>

        <!-- Principal content -->
        <main class="content">

            <!-- Header -->
            <div th:replace="fragments/header :: header"></div>

            <!-- Certificat -->
            <div th:replace="fragments/certificat :: certificat"></div>

            <!-- Popup d'erreur -->
            <div th:replace="fragments/error :: error"></div>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function() {
    const $sidebar = $('.sidebar');
    const $hoverArea = $('.hover-area');

    $hoverArea.on('mouseenter', function() {
        $sidebar.addClass('visible');
    });

    $sidebar.on('mouseleave', function() {
        $sidebar.removeClass('visible');
    });

    $('form').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const login = form.find('input[name="login"]').val();
        const signerPar = form.find('select[name="signer_par"]').val();
        const button = form.find('button[type="submit"]');

        // Validation côté client
        if (!login || login.trim() === '') {
            alert('Le login est requis');
            return;
        }

        button.prop('disabled', true);
        $('#loader').show();

        const url = `/certificate-generator?login=${encodeURIComponent(login)}&signer_par=${encodeURIComponent(signerPar)}`;

        fetch(url)
            .then(response => {
                // Vérifier le Content-Type pour savoir comment traiter la réponse
                const contentType = response.headers.get('content-type');
                
                if (!response.ok) {
                    // Si c'est du JSON, essayer de le parser
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Erreur inconnue du serveur');
                        });
                    } else {
                        // Si ce n'est pas du JSON, utiliser le texte de statut
                        throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                    }
                }
                
                // Vérifier que c'est bien un PDF
                if (contentType && contentType.includes('application/pdf')) {
                    return response.blob();
                } else {
                    throw new Error('Format de réponse inattendu. PDF attendu.');
                }
            })
            .then(blob => {
                // Créer et télécharger le fichier PDF
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `certificat_scolarite_${login}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Nettoyer l'URL object
                window.URL.revokeObjectURL(link.href);
            })
            .catch(err => {
                console.error('Erreur lors de la génération du certificat:', err);
                alert('Erreur: ' + err.message);
            })
            .finally(() => {
                $('#loader').hide();
                button.prop('disabled', false);
            });
    });

    // Custom select handling
    $('.sel').each(function() {
        $(this).children('select').css('display', 'none');
        var $current = $(this);
        $(this).find('option').each(function(i) {
            if (i === 0) {
                $current.prepend($('<div>', { class: $current.attr('class').replace(/sel/g, 'sel__box') }));
                var placeholder = $(this).text();
                $current.prepend($('<span>', {
                    class: $current.attr('class').replace(/sel/g, 'sel__placeholder'),
                    text: placeholder,
                    'data-placeholder': placeholder
                }));
                return;
            }
            $current.children('div').append($('<span>', {
                class: $current.attr('class').replace(/sel/g, 'sel__box__options'),
                text: $(this).text()
            }));
        });
    });

    $('.sel').click(function() { 
        $(this).toggleClass('active'); 
    });

    $(document).on('click', '.sel__box__options', function() {
        var txt = $(this).text();
        var index = $(this).index();
        $(this).siblings('.sel__box__options').removeClass('selected');
        $(this).addClass('selected');
        var $currentSel = $(this).closest('.sel');
        $currentSel.children('.sel__placeholder').text(txt);
        $currentSel.children('select').prop('selectedIndex', index + 1);
    });
});
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const popup = document.getElementById("errorPopup");
            if(popup) {
                popup.style.display = "block";
                popup.querySelector(".close").onclick = function() {
                    popup.style.display = "none";
                }
                window.onclick = function(event) {
                    if(event.target === popup) {
                        popup.style.display = "none";
                    }
                }
            }
        });
    </script>
</body>
</html>